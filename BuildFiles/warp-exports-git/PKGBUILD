# Maintainer: MoYingJi <moyingjiaw@outlook.com>

#shellcheck disable=SC2103

# SEE: https://wiki.archlinuxcn.org/wiki/PKGBUILD
# SEE: https://wiki.archlinuxcn.org/wiki/创建软件包#创建PKGBUILD

pkgname=warp-exports-git
pkgver=1
pkgrel=1
pkgdesc="" # opt
arch=('x86_64') # or any
license=("MIT")
depends=(electron33)
makedepends=(yarn)
source=(
	a.patch
	launcher-builder
	git+https://github.com/biuuu/genshin-wish-export
	git+https://github.com/biuuu/star-rail-warp-export/
	git+https://github.com/earthjasonlin/zzz-signal-search-export
)
sha256sums=(SKIP SKIP SKIP SKIP SKIP)

exporters=(
	genshin-wish-export
	star-rail-warp-export
	zzz-signal-search-export
)

prepare() {
	for e in "${exporters[@]}"; do
		cd "$e"
		patch ./src/main/utils.js < ../a.patch

		# 为什么你非要 png 格式啊？
		shopt -s nullglob
		for f in ./build/src/*.jpeg; do
   			mv -- "$f" "${f%.jpeg}.png"
		done
		shopt -u nullglob

		cd ..
	done
}

build() {
	mkdir -p launchers
	chmod +x ./launcher-builder

	for e in "${exporters[@]}"; do
		cd "$e"
		yarn install
		yarn build:linux
		cd ..

		./launcher-builder "$e" "launchers/$e"
	done
}

package() {
	for e in "${exporters[@]}"; do
		install -Dm755 -d "$pkgdir/usr/lib/warp-exports/$e"
		chown -R 0:0 "$e/build/linux-unpacked/resources/app"
		cp -Pr --no-preserve=ownership "$e/build/linux-unpacked/resources/app" "$pkgdir/usr/lib/warp-exports/$e"
		install -Dm755 "launchers/$e" "$pkgdir/usr/bin/$e"
	done
}

